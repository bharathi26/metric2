CREATE PROCEDURE METRIC2.M2_P_WIDGET_HISTORY(v_dwid INT, v_startdt VARCHAR(30), v_enddt VARCHAR(30)) LANGUAGE SQLSCRIPT AS BEGIN SELECT TO_CHAR(metric2.m2_dwp_history.dt_added, 'YYYY') as year, TO_CHAR(metric2.m2_dwp_history.dt_added, 'MM') as month, TO_CHAR(metric2.m2_dwp_history.dt_added, 'DD') as day, TO_CHAR(metric2.m2_dwp_history.dt_added, 'HH24') as hour, TO_CHAR(metric2.m2_dwp_history.dt_added, 'MI') as min, '00' as secs, TO_DECIMAL(AVG(TO_INT(metric2.m2_dwp_history.value)),2,2) as value from metric2.m2_dwp_history INNER JOIN metric2.m2_dashboard_widget_params ON metric2.m2_dwp_history.dashboard_widget_param_id = metric2.m2_dashboard_widget_params.dashboard_widget_param_id INNER JOIN metric2.m2_widget_param ON metric2.m2_widget_param.param_id = metric2.m2_dashboard_widget_params.param_id WHERE  metric2.m2_dashboard_widget_params.dashboard_widget_id = :v_dwid AND (TO_DATE(TO_CHAR(metric2.m2_dwp_history.dt_added, 'MM/DD/YYYY'),'MM/DD/YYYY') between TO_DATE(:v_startdt,'MM/DD/YYYY')  AND TO_DATE(:v_enddt,'MM/DD/YYYY')) GROUP BY TO_CHAR(metric2.m2_dwp_history.dt_added, 'YYYY'), TO_CHAR(metric2.m2_dwp_history.dt_added, 'MM'), TO_CHAR(metric2.m2_dwp_history.dt_added, 'DD'), TO_CHAR(metric2.m2_dwp_history.dt_added, 'HH24'), TO_CHAR(metric2.m2_dwp_history.dt_added, 'MI') ORDER BY day desc, hour desc, min desc; END;